<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arizona AI | Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=13">
</head>

<body>
    <canvas id="plexus-canvas"></canvas>

    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="brand"><i class="fa-solid fa-layer-group"></i>&nbsp;Arizona AI</div>

            <nav class="nav-menu">
                <div class="nav-item active" onclick="ArizonaModule.selectTool('overview', this)">
                    <i class="fa-solid fa-grid-2"></i>
                    <span>Обзор</span>
                </div>
                <div class="nav-item" onclick="ArizonaModule.selectTool('helper', this)">
                    <i class="fa-solid fa-robot"></i>
                    <span>AI Помощник</span>
                </div>
                <div class="nav-item" onclick="ArizonaModule.selectTool('rules', this)">
                    <i class="fa-solid fa-book"></i>
                    <span>База Правил</span>
                </div>
                <div class="nav-item" onclick="ArizonaModule.selectTool('smi', this)">
                    <i class="fa-solid fa-pen-nib"></i>
                    <span>СМИ Редактор</span>
                </div>
                <div class="nav-item" onclick="ArizonaModule.selectTool('complaint', this)">
                    <i class="fa-solid fa-gavel"></i>
                    <span>Генератор Жалоб</span>
                </div>
                <div class="nav-item" onclick="ArizonaModule.selectTool('legend', this)">
                    <i class="fa-solid fa-user-secret"></i>
                    <span>RP Биография</span>
                </div>
                <div class="nav-item" onclick="ArizonaModule.selectTool('news', this)">
                    <i class="fa-solid fa-newspaper"></i>
                    <span>Новости</span>
                </div>
            </nav>

            <div class="sidebar-profile"
                onclick="ArizonaModule.selectTool('profile', document.querySelector('.nav-item.profile-dummy'))">
                {% if user %}
                <img src="{{ user.avatar }}" alt="Avatar" class="mini-avatar">
                <div class="mini-user-info">
                    <span class="mini-username">{{ user.username }}</span>
                    <span class="mini-status">Online</span>
                </div>
                {% else %}
                <div class="mini-user-info">
                    <span class="mini-username">Guest</span>
                    <span class="mini-status" style="color:var(--text-secondary);">Not authorized</span>
                </div>
                {% endif %}
            </div>
            <!-- Hidden dummy for profile activation logic if needed -->
            <div class="nav-item profile-dummy hidden" onclick="ArizonaModule.selectTool('profile', this)"
                style="display:none;"></div>
        </aside>

        <!-- MAIN CONTENT -->
        <main>

            <!-- TAB 0: OVERVIEW (BENTO HOME) -->
            <div id="arizona-tool-overview" class="workspace-tab active">
                <div class="bento-header">
                    <h1 class="bento-title">Обзор</h1>
                    <p class="bento-subtitle">Добро пожаловать в панель управления, {{ user.username if user else
                        'Гость' }}.</p>
                </div>

                <div class="bento-grid-sidebar-layout">
                    <!-- LEFT COLUMN (Big Widgets) -->
                    <div style="display:flex; flex-direction:column; gap:20px;">
                        <!-- Quick Stats Row -->
                        <div class="bento-grid-3">
                            <div class="bento-card">
                                <div class="card-title"><span>Статус Бота</span> <i class="fa-solid fa-server"></i>
                                </div>
                                <div class="stat-number" style="color:#00ff88; font-size:32px;">Online</div>
                                <div style="margin-top:auto; font-size:12px; opacity:0.5;">Uptime: {{ uptime }}</div>
                            </div>
                            <div class="bento-card">
                                <div class="card-title"><span>Правила</span> <i class="fa-solid fa-book-open"></i></div>
                                <div class="stat-number" style="font-size:32px;">Loaded</div>
                                <div style="margin-top:auto; font-size:12px; opacity:0.5;">База данных активна</div>
                            </div>
                            <div class="bento-card">
                                <div class="card-title"><span>AI Мозг</span> <i class="fa-solid fa-brain"></i></div>
                                <div class="stat-number" style="color:var(--highlight); font-size:32px;">Gemini 2.0
                                </div>
                                <div style="margin-top:auto; font-size:12px; opacity:0.5;">Готов к работе</div>
                            </div>
                        </div>

                        <!-- Quick Action: Helper -->
                        <div class="bento-card" style="flex:1; min-height:250px;">
                            <div class="card-title"><span>Быстрый вопрос AI</span> <i class="fa-solid fa-bolt"></i>
                            </div>
                            <div style="margin-top:auto;">
                                <input type="text" placeholder="Узнать наказание за ДМ..." id="overview-input"
                                    style="margin-bottom:10px;">
                                <div style="display:flex; gap:10px;">
                                    <button class="btn primary"
                                        onclick="ArizonaModule.askQuickHelper()">Спросить</button>
                                    <button class="btn"
                                        onclick="ArizonaModule.selectTool('helper', document.querySelectorAll('.nav-item')[1])">Перейти
                                        в чат</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN (News/Profile) -->
                    <div style="display:flex; flex-direction:column; gap:20px;">
                        <div class="bento-card">
                            <div class="card-title">
                                <span>Новости Arizona</span>
                                <button class="btn" style="padding:4px 8px; font-size:10px;"
                                    onclick="window.loadNews()">Refresh</button>
                            </div>
                            <div id="mini-news-container"
                                style="flex:1; overflow:hidden; font-size:13px; color:var(--text-secondary);">
                                <div style="opacity:0.5; padding:20px 0;">Загрузка ленты...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 1: HELPER -->
            <div id="arizona-tool-helper" class="workspace-tab">
                <div class="bento-header">
                    <h1 class="bento-title">AI Помощник</h1>
                </div>
                <div class="bento-card" style="height: calc(100vh - 140px);">
                    <div id="chat-history" class="chat-box">
                        <div class="message ai"><strong>AI:</strong> Привет! Я готов отвечать на вопросы по правилам и
                            системам Arizona RP.</div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="helper-input" placeholder="Введите ваш вопрос..." style="margin:0;">
                        <button class="btn primary" onclick="window.askHelper()">➤</button>
                    </div>
                </div>
            </div>

            <!-- TAB 2: RULES -->
            <div id="arizona-tool-rules" class="workspace-tab">
                <div class="bento-header">
                    <h1 class="bento-title">База Правил</h1>
                </div>
                <div class="bento-card">
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <input type="text" id="rules-search" placeholder="Поиск правила (например: СК, Капт, Порт)..."
                            style="margin:0;">
                        <button class="btn primary" onclick="window.searchRules()">Найти</button>
                    </div>
                    <div id="rules-result" style="line-height:1.6; color:#efefef;"></div>
                </div>
            </div>

            <!-- TAB 3: SMI EDITOR -->
            <div id="arizona-tool-smi" class="workspace-tab">
                <div class="bento-header">
                    <h1 class="bento-title">СМИ Редактор</h1>
                </div>
                <div class="bento-grid-2">
                    <div class="bento-card">
                        <div class="card-title">Исходный текст</div>
                        <textarea id="smi-input" style="height:200px; resize:none;"
                            placeholder="Вставьте сырое объявление... (например: продам нрг 50кк)"></textarea>
                        <button class="btn primary" onclick="window.editAd()">Отредактировать (AI)</button>
                    </div>
                    <div class="bento-card">
                        <div class="card-title">Результат</div>
                        <div id="smi-result"
                            style="background:rgba(0,0,0,0.3); border-radius:12px; padding:20px; height:200px; display:flex; align-items:center; justify-content:center; border:1px dashed var(--card-border);">
                            <span id="smi-output" style="font-size:18px; color:#fff; text-align:center;">Здесь появится
                                результат</span>
                        </div>
                        <button class="btn" style="margin-top:auto;"
                            onclick="navigator.clipboard.writeText(document.getElementById('smi-output').innerText)">Копировать</button>
                    </div>
                </div>
            </div>

            <!-- TAB 4: COMPLAINT -->
            <div id="arizona-tool-complaint" class="workspace-tab">
                <div class="bento-header">
                    <h1 class="bento-title">Генератор Жалоб</h1>
                </div>
                <div class="bento-card">
                    <div class="bento-grid-2" style="margin-bottom:20px;">
                        <input type="text" id="comp-nick" placeholder="Никнейм нарушителя">
                        <input type="text" id="comp-rule" placeholder="Нарушенное правило (необязательно)">
                    </div>
                    <textarea id="comp-desc" placeholder="Опишите ситуацию подробно..."
                        style="height:100px;"></textarea>
                    <button class="btn primary" onclick="window.genComplaint()">Сгенерировать</button>

                    <div id="comp-result" style="margin-top:20px; display:none;">
                        <div class="card-title">Готовый текст</div>
                        <pre id="comp-output"
                            style="background:rgba(0,0,0,0.3); padding:20px; border-radius:12px; white-space:pre-wrap; color:#ddd; font-family:monospace;"></pre>
                    </div>
                </div>
            </div>

            <!-- TAB 5: RP LEGEND -->
            <div id="arizona-tool-legend" class="workspace-tab">
                <div class="bento-header">
                    <h1 class="bento-title">RP Биография</h1>
                </div>
                <div class="bento-card">
                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
                        <input type="text" id="bio-name" placeholder="Имя Персонажа">
                        <select id="bio-style" style="margin:0;">
                            <option value="neutral">Гражданский</option>
                            <option value="criminal">Бандит / Мафия</option>
                            <option value="cop">Полицейский / ФБР</option>
                            <option value="business">Богач / Бизнесмен</option>
                        </select>
                    </div>
                    <button class="btn primary" onclick="window.genBio()" style="margin-top:10px;">Создать
                        Историю</button>
                    <div id="bio-result"
                        style="margin-top:20px; padding:20px; background:rgba(0,0,0,0.2); border-radius:12px; display:none;">
                        <div id="bio-output" style="line-height:1.6; color:#ddd;"></div>
                    </div>
                </div>
            </div>

            <!-- TAB 6: NEWS -->
            <div id="arizona-tool-news" class="workspace-tab">
                <div class="bento-header">
                    <h1 class="bento-title">Новости Сервера</h1>
                </div>
                <div id="news-container" class="bento-grid-3">
                    <div class="bento-card">
                        <div style="padding:20px;">Загрузка...</div>
                    </div>
                </div>
            </div>

            <!-- TAB 7: PROFILE -->
            <div id="arizona-tool-profile" class="workspace-tab">
                <div class="bento-header">
                    <h1 class="bento-title">Профиль</h1>
                </div>
                <div class="bento-card" style="max-width:600px; margin:0 auto; text-align:center; padding:60px;">
                    {% if user %}
                    <img src="{{ user.avatar }}" alt="Avatar"
                        style="width:120px; height:120px; border-radius:50%; border: 4px solid var(--card-border); margin-bottom: 20px;">
                    <h2 style="font-size: 32px; color: #fff; margin-bottom: 10px;">{{ user.username }}</h2>
                    <div
                        style="display:inline-block; padding:8px 16px; background:rgba(255,255,255,0.05); border-radius:20px; margin-bottom:40px;">
                        ID: {{ user.id }}
                    </div>
                    <div style="display:flex; justify-content:center; gap:20px;">
                        <a href="/logout" class="btn" style="border-color:#ff4444; color:#ff4444;">
                            <i class="fa-solid fa-sign-out-alt"></i> Выйти из системы
                        </a>
                    </div>
                    {% else %}
                    <h2>Вы не авторизованы</h2>
                    <p style="margin:20px 0;">Войдите, чтобы использовать все функции.</p>
                    <a href="{{ auth_url }}" class="btn primary">Войти через Discord</a>
                    {% endif %}
                </div>
            </div>

        </main>
    </div>

    <!-- SCRIPTS -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}?v=13"></script>
    <script>
        // --- BENTO LOGIC ---

        // Tab Switching
        window.ArizonaModule = {
            selectTool: (id, el) => {
                // Nav active state
                document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
                if (el && !el.classList.contains('profile-dummy')) el.classList.add('active');

                // Content tab switch
                document.querySelectorAll('.workspace-tab').forEach(x => {
                    x.classList.remove('active');
                });
                const t = document.getElementById('arizona-tool-' + id);
                if (t) t.classList.add('active');

                // Specific init
                if (id === 'news' && window.loadNews) window.loadNews();
            },

            askQuickHelper: async () => {
                const q = document.getElementById('overview-input').value;
                if (!q) return;
                // Switch to helper tab
                window.ArizonaModule.selectTool('helper', document.querySelectorAll('.nav-item')[1]);
                // Inject query
                document.getElementById('helper-input').value = q;
                window.askHelper();
            }
        };

        // --- OLD FUNCTIONS MAPPING (To keep compatibility with dashboard.js if external, otherwise redefine here) ---

        window.askHelper = async () => {
            const i = document.getElementById('helper-input');
            const box = document.getElementById('chat-history');
            if (!i.value) return;
            box.innerHTML += `<div class="message user"><strong>Вы:</strong> ${i.value}</div>`;
            const q = i.value; i.value = '';

            try {
                const r = await fetch('/api/arizona/helper', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: q }) });
                const d = await r.json();
                box.innerHTML += `<div class="message ai"><strong>AI:</strong> ${marked.parse(d.response || d.error)}</div>`;
                box.scrollTop = box.scrollHeight;
            } catch (e) { box.innerHTML += `<div class="message ai" style="color:red">Ошибка сети</div>`; }
        };

        window.genComplaint = async () => {
            const n = document.getElementById('comp-nick').value;
            const desc = document.getElementById('comp-desc').value;
            try {
                const r = await fetch('/api/arizona/complaint', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nickname: n, description: desc }) });
                const res = await r.json();
                document.getElementById('comp-result').style.display = 'block';
                document.getElementById('comp-output').innerText = res.response || res.error;
            } catch (e) { alert('Ошибка'); }
        };

        window.genBio = async () => {
            const n = document.getElementById('bio-name').value;
            const s = document.getElementById('bio-style').value;
            try {
                const r = await fetch('/api/arizona/legend', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: n, style: s }) });
                const res = await r.json();
                document.getElementById('bio-result').style.display = 'block';
                document.getElementById('bio-output').innerHTML = marked.parse(res.response || res.error);
            } catch (e) { alert('Ошибка'); }
        };

        window.searchRules = async () => {
            const q = document.getElementById('rules-search').value;
            const resBox = document.getElementById('rules-result');
            resBox.innerHTML = 'Поиск...';
            try {
                const r = await fetch('/api/arizona/rules', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: q }) });
                const d = await r.json();
                resBox.innerHTML = marked.parse(d.response || d.error);
            } catch (e) { resBox.innerHTML = 'Ошибка'; }
        };

        window.editAd = async () => {
            const t = document.getElementById('smi-input').value;
            const out = document.getElementById('smi-output');
            out.innerText = "Думаем...";
            try {
                const r = await fetch('/api/arizona/smi/edit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: t }) });
                const d = await r.json();
                out.innerText = d.response || d.error;
            } catch (e) { out.innerText = 'Ошибка'; }
        };

        // --- BACKGROUND PLEXUS RELOADED ---
        const canvas = document.getElementById('plexus-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        const mouse = { x: null, y: null, radius: 250 };

        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
        window.addEventListener('mouseout', () => { mouse.x = null; mouse.y = null; });
        window.addEventListener('resize', resize);

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            initParticles();
        }

        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 0.5; // Slower for bento elegance
                this.vy = (Math.random() - 0.5) * 0.5;
                this.size = Math.random() * 2 + 1;
                this.color = '#45a29e';
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                if (this.x < 0 || this.x > width) this.vx *= -1;
                if (this.y < 0 || this.y > height) this.vy *= -1;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
        }

        function initParticles() {
            particles = [];
            let count = (width * height) / 15000; // Less particles for cleaner look
            for (let i = 0; i < count; i++) particles.push(new Particle());
        }

        function animate() {
            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, width, height);
            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
                for (let j = i; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 150) {
                        ctx.beginPath();
                        ctx.strokeStyle = `rgba(69, 162, 158, ${0.5 - distance / 150})`;
                        ctx.lineWidth = 0.5;
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.stroke();
                    }
                }
            }
        }

        resize();
        animate();

        // Auto Load News on Overview
        setTimeout(() => {
            if (window.loadNews) window.loadNews();
            // Fill mini news
            try {
                // A simplified fetch for overview widget
                // For now reuse loadNews but logic might differ for widget
            } catch (e) { }
        }, 1000);

    </script>
</body>

</html>